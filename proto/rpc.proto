syntax = "proto3";

import "Log.proto";
import "JobStatus.proto";
import "JobState.proto";
import "JobParam.proto";
import "JobInput.proto";
import "JobResult.proto";
import "Job.proto";

message RpcRequestJob {
    string runOn = 1;
    uint64 expireAfter = 2;
    repeated JobInput input = 3;
    repeated JobParam param = 4;
    string description = 6;
    optional uint32 kind = 7;
    optional string outputFormat = 8; 
}

message RpcGetJob {
    string jobId = 1;
}

message RpcGetPendingJobs {
    optional string filterByRunOn = 1;
    optional string filterByCustomer = 2;
    optional string filterByDescription = 3;
    optional string filterById = 4;
    optional string filterByKind = 5;
}

message PendingJobs {
    repeated Job jobs = 1;
}


message RpcIsJobDone {
  bool isDone = 1;
}

message RpcAcceptJob {
  string jobId = 1;
}

message RpcCancelJob {
  string jobId = 1;
  string reason = 2;
}

message RpcJobOutput{
  string jobId = 1;
  string output = 2;
}

message RpcJobComplete{
  string jobId = 1;
  string output = 2;
  optional string info = 3;
}

message RpcJobLog {
  string jobId = 1;
  string log = 2;

}

message RpcSendSignedEventRequest {
  string groupId = 1; // the group id of the event, will be used for gc, etc. If generated by a job it should be set to the job id
  string event = 2;
}

message RpcSubscribeToEventsRequest {
  string groupId = 1; // the group id of the event, will be used for gc, etc. If generated by a job it should be set to the job id
  repeated string filters = 2;
}

message RpcSubscribeToEventsResponse{
  string groupId  = 1; // the group id of the event, will be used for gc, etc. If generated by a job it should be set to the job id
  string subscriptionId = 2;
}

message RpcGetEventsRequest {
  string groupId = 1; // the group id of the event, will be used for gc, etc. If generated by a job it should be set to the job id
  string subscriptionId = 2;
  uint32 limit = 3; // optional : 0 or unset means no limit
}

message RpcGetEventsResponse {
  string groupId = 1; // the group id of the event, will be used for gc, etc. If generated by a job it should be set to the job id
  uint32 count = 2;
  string subscriptionId = 3;
  repeated string events = 4;
}


message RpcSendSignedEventResponse{
  string groupId = 1; // the group id of the event, will be used for gc, etc. If generated by a job it should be set to the job id
  bool success = 2;
}

message RpcUnsubscribeFromEventsRequest{
  string groupId = 1; // the group id of the event, will be used for gc, etc. If generated by a job it should be set to the job id
  string subscriptionId = 2;
}

message RpcUnsubscribeFromEventsResponse{
  bool success = 1;
}


message RpcAnnounceNodeRequest {
  string iconUrl = 3;
  string name = 4;
  string description = 5;
}

message RpcAnnounceNodeResponse {
  bool success = 1;
  uint64 refreshInterval = 4;
  
}

message RpcAnnounceTemplateRequest { 
  string meta = 1;
  string template = 2;
  string sockets = 3;  
}

message RpcAnnounceTemplateResponse {
  bool success = 1;
  uint64 refreshInterval = 4;
}

service PoolConnector {
    // job management
    rpc requestJob (RpcRequestJob) returns (Job);
    rpc getJob (RpcGetJob) returns (Job);
    rpc getPendingJobs (RpcGetPendingJobs) returns (PendingJobs);
    rpc isJobDone (RpcGetJob) returns (RpcIsJobDone);
    rpc acceptJob(RpcAcceptJob) returns (Job);
    rpc cancelJob(RpcCancelJob) returns (Job);
    rpc outputForJob(RpcJobOutput) returns (Job);
    rpc completeJob(RpcJobComplete) returns (Job);
    rpc logForJob(RpcJobLog) returns (Job);


    // discovery
    rpc announceNode (RpcAnnounceNodeRequest) returns (RpcAnnounceNodeResponse);
    rpc announceEventTemplate (RpcAnnounceTemplateRequest) returns (RpcAnnounceTemplateResponse);


    // generic nostr events
    rpc sendSignedEvent (RpcSendSignedEventRequest) returns (RpcSendSignedEventResponse);
    rpc subscribeToEvents (RpcSubscribeToEventsRequest) returns (RpcSubscribeToEventsResponse);
    rpc unsubscribeFromEvents (RpcUnsubscribeFromEventsRequest) returns (RpcUnsubscribeFromEventsResponse);
    rpc getEvents(RpcGetEventsRequest) returns (RpcGetEventsResponse);
}








